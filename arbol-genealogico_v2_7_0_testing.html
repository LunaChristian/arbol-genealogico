<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de √Årboles Geneal√≥gicos</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600&family=Work+Sans:wght@400;500;600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #c0392b;
            --light: #ecf0f1;
            --white: #ffffff;
            --border: #bdc3c7;
        }
        
        body {
            font-family: 'Work Sans', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8eef3 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 420px 1fr;
            gap: 30px;
        }
        
        .panel {
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 30px;
        }
        
        h1 {
            font-family: 'Crimson Pro', serif;
            font-size: 2.5em;
            color: var(--primary);
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        h2 {
            font-family: 'Crimson Pro', serif;
            font-size: 1.8em;
            color: var(--primary);
            margin-bottom: 20px;
            border-bottom: 3px solid var(--accent);
            padding-bottom: 10px;
        }
        
        .subtitle {
            color: var(--secondary);
            margin-bottom: 30px;
            font-size: 0.95em;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            color: var(--secondary);
            font-weight: 500;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 6px;
            font-family: 'Work Sans', sans-serif;
            font-size: 0.95em;
            transition: all 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(192, 57, 43, 0.1);
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-family: 'Work Sans', sans-serif;
            font-weight: 600;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-primary {
            background: var(--accent);
            color: white;
            width: 100%;
            margin-top: 10px;
        }
        
        .btn-primary:hover {
            background: #a93226;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(192, 57, 43, 0.3);
        }
        
        .btn-secondary {
            background: var(--secondary);
            color: white;
            margin-right: 10px;
        }
        
        .btn-secondary:hover {
            background: var(--primary);
        }
        
        .btn-export {
            background: #27ae60;
            color: white;
        }
        
        .btn-export:hover {
            background: #229954;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.8em;
            margin-left: 10px;
        }
        
        .person-list {
            margin-top: 30px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .person-item {
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid var(--accent);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .person-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .btn-delete {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.75em;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .person-item:hover .btn-delete {
            opacity: 1;
        }
        
        .btn-delete:hover {
            background: #c0392b;
        }
        
        .person-name {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .person-details {
            font-size: 0.85em;
            color: var(--secondary);
        }
        
        .tree-canvas {
            min-height: 700px;
            height: 700px;
            position: relative;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden; /* Sin scroll, usaremos zoom */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .tree-canvas-inner {
            position: relative;
            transform-origin: center center;
            transition: transform 0.3s ease;
            max-width: 100%;
            max-height: 100%;
        }
        
        .tree-node {
            position: absolute;
            background: white;
            border: 2px solid var(--primary);
            border-radius: 8px;
            padding: 12px 15px;
            min-width: 220px;
            max-width: 220px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-size: 0.85em;
        }
        
        .tree-node-name {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
            font-size: 1.05em;
            font-family: 'Crimson Pro', serif;
            text-align: center;
            text-transform: uppercase;
        }
        
        .tree-node-detail {
            color: var(--secondary);
            margin: 2px 0;
            font-size: 0.88em;
            line-height: 1.4;
        }
        
        svg {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 0;
        }
        
        .tree-node {
            z-index: 1;
        }
        
        .actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        
        .helper-text {
            background: #fff9e6;
            border-left: 4px solid #f39c12;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            font-size: 0.9em;
            color: #7f6a00;
        }
        
        .matrimonios-container {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .matrimonio-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }
        
        .matrimonio-item input {
            flex: 1;
        }
        
        @media print {
            * {
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
            }
            
            /* NO especificar @page - dejar que usuario configure */
            
            body {
                background: white;
                margin: 0;
                padding: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                min-height: 100vh;
            }
            
            /* Ocultar panel de entrada */
            .panel:first-child {
                display: none !important;
            }
            
            /* Contenedor centrado */
            .container {
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0;
                padding: 0;
            }
            
            /* Panel centrado */
            .panel {
                box-shadow: none;
                border: none;
                border-radius: 0;
                padding: 0;
                margin: 0;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            /* Ocultar t√≠tulo */
            .panel h2 {
                display: none !important;
            }
            
            /* Canvas sin dimensiones fijas */
            .tree-canvas {
                border: none;
                border-radius: 0;
                overflow: visible;
                page-break-inside: avoid;
                page-break-after: avoid;
                background: transparent;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            /* Inner se centra con flexbox del padre */
            .tree-canvas-inner {
                transform-origin: center center;
                /* transform aplicado din√°micamente por exportToPDF() */
            }
            
            /* Nodos no se cortan */
            .tree-node {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Panel de entrada de datos -->
        <div class="panel">
            <h1>üìã √Årbol Geneal√≥gico</h1>
            <p class="subtitle">Generador profesional de √°rboles familiares</p>
            
            <div class="helper-text">
                <strong>C√≥mo usar:</strong> Completa los datos y presiona "Agregar Persona". Puedes agregar hasta 3 matrimonios por persona. <strong>Click en cualquier persona de la lista para editarla.</strong>
            </div>
            
            <form id="personForm">
                <div class="form-group">
                    <label>Nombre Completo *</label>
                    <input type="text" id="nombre" required placeholder="Ej: Juan Carlos P√©rez">
                </div>
                
                <div class="form-group" style="display:none;">
                    <label>Fecha de Nacimiento</label>
                    <input type="text" id="fechaNac" placeholder="Ej: 15/03/1950">
                </div>
                
                <div class="form-group" style="display:none;">
                    <label>Lugar de Nacimiento</label>
                    <input type="text" id="lugarNac" placeholder="Ej: Buenos Aires">
                </div>
                
                <div class="form-group" style="display:none;">
                    <label>Matrimonios</label>
                    <div class="matrimonios-container" id="matrimoniosContainer">
                        <div class="matrimonio-item">
                            <div style="flex: 1;">
                                <input type="text" id="mat1_fecha" placeholder="Fecha (20/05/1975)">
                            </div>
                            <div style="flex: 1;">
                                <input type="text" id="mat1_conyuge" placeholder="Nombre del c√≥nyuge">
                            </div>
                        </div>
                        <div class="matrimonio-item" style="display:none;" id="mat2Container">
                            <div style="flex: 1;">
                                <input type="text" id="mat2_fecha" placeholder="Fecha 2do Mat.">
                            </div>
                            <div style="flex: 1;">
                                <input type="text" id="mat2_conyuge" placeholder="Nombre del c√≥nyuge">
                            </div>
                        </div>
                        <div class="matrimonio-item" style="display:none;" id="mat3Container">
                            <div style="flex: 1;">
                                <input type="text" id="mat3_fecha" placeholder="Fecha 3er Mat.">
                            </div>
                            <div style="flex: 1;">
                                <input type="text" id="mat3_conyuge" placeholder="Nombre del c√≥nyuge">
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary btn-small" onclick="agregarMatrimonio()">+ Agregar Matrimonio</button>
                </div>
                
                <div class="form-group" style="display:none;">
                    <label>Fecha de Defunci√≥n</label>
                    <input type="text" id="fechaDef" placeholder="Dejar vac√≠o si vive">
                </div>
                
                <div class="form-group">
                    <label>Relaci√≥n Familiar</label>
                    <select id="relacion">
                        <option value="">Ninguna (Persona inicial)</option>
                        <option value="padre">Es padre/madre de...</option>
                        <option value="hijo">Es hijo/a de...</option>
                    </select>
                </div>
                
                <div class="form-group" id="relacionPersonaGroup" style="display: none;">
                    <label>¬øDe qui√©n?</label>
                    <select id="relacionPersona">
                        <option value="">Seleccionar persona...</option>
                    </select>
                </div>
                
                <button type="submit" class="btn btn-primary">+ Agregar Persona</button>
                <button type="button" class="btn btn-secondary" onclick="cancelarEdicion()" id="btnCancelar" style="display:none; width:100%; margin-top:10px;">Cancelar Edici√≥n</button>
            </form>
            
            <div class="person-list" id="personList"></div>
            
            <div class="actions">
                <button class="btn btn-secondary" onclick="clearAll()">Limpiar Todo</button>
                <button class="btn btn-export" onclick="exportToPDF()">Exportar PDF</button>
            </div>
        </div>
        
        <!-- Panel del √°rbol -->
        <div class="panel">
            <h2>Vista del √Årbol Geneal√≥gico</h2>
            <div class="tree-canvas" id="treeCanvas">
                <div class="tree-canvas-inner" id="treeCanvasInner">
                    <svg id="linesSvg"></svg>
                </div>
            </div>
        </div>
    </div>

    <script>
        let personas = [];
        let nextId = 1;
        let matrimoniosCount = 1;
        let editandoId = null;
        
        const NODE_WIDTH = 220;
        const NODE_HEIGHT = 80; // Altura estimada de cada nodo (m√°s realista)
        const V_GAP = 8; // Gap entre niveles (separaci√≥n vertical)
        const H_SPACING = 10; // Gap horizontal entre hermanos normales
        const H_SPACING_SIBLINGS = 30; // Gap entre hermanos cuando ambos tienen hijos
        const MARGIN = 50;
        
        function agregarMatrimonio() {
            if (matrimoniosCount < 3) {
                matrimoniosCount++;
                document.getElementById(`mat${matrimoniosCount}Container`).style.display = 'flex';
            }
        }
        
        function updateRelacionSelect() {
            const select = document.getElementById('relacionPersona');
            select.innerHTML = '<option value="">Seleccionar persona...</option>';
            
            personas.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.nombre;
                select.appendChild(option);
            });
        }
        
        document.getElementById('relacion').addEventListener('change', function(e) {
            const group = document.getElementById('relacionPersonaGroup');
            group.style.display = e.target.value ? 'block' : 'none';
        });
        
        document.getElementById('personForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const matrimonios = [];
            for (let i = 1; i <= 3; i++) {
                const fecha = document.getElementById(`mat${i}_fecha`).value;
                const nombreConyuge = document.getElementById(`mat${i}_conyuge`).value;
                
                if (fecha || nombreConyuge) {
                    matrimonios.push({ fecha, nombreConyuge });
                }
            }
            
            if (editandoId !== null) {
                const persona = personas.find(p => p.id === editandoId);
                persona.nombre = document.getElementById('nombre').value;
                persona.fechaNac = document.getElementById('fechaNac').value;
                persona.lugarNac = document.getElementById('lugarNac').value;
                persona.matrimonios = matrimonios;
                persona.fechaDef = document.getElementById('fechaDef').value;
                
                cancelarEdicion();
            } else {
                const persona = {
                    id: nextId++,
                    nombre: document.getElementById('nombre').value,
                    fechaNac: document.getElementById('fechaNac').value,
                    lugarNac: document.getElementById('lugarNac').value,
                    matrimonios: matrimonios,
                    fechaDef: document.getElementById('fechaDef').value,
                    padres: [],
                    hijos: []
                };
                
                const relacion = document.getElementById('relacion').value;
                const relacionPersonaId = parseInt(document.getElementById('relacionPersona').value);
                
                if (relacion && relacionPersonaId) {
                    const relacionPersona = personas.find(p => p.id === relacionPersonaId);
                    
                    if (relacion === 'padre') {
                        relacionPersona.padres.push(persona.id);
                        persona.hijos.push(relacionPersonaId);
                    } else if (relacion === 'hijo') {
                        relacionPersona.hijos.push(persona.id);
                        persona.padres.push(relacionPersonaId);
                    }
                }
                
                personas.push(persona);
                
                e.target.reset();
                matrimoniosCount = 1;
                document.getElementById('mat2Container').style.display = 'none';
                document.getElementById('mat3Container').style.display = 'none';
            }
            
            updatePersonList();
            updateRelacionSelect();
            drawTree();
        });
        
        function updatePersonList() {
            const list = document.getElementById('personList');
            list.innerHTML = '';
            
            personas.forEach(p => {
                const item = document.createElement('div');
                item.className = 'person-item';
                item.innerHTML = `
                    <div class="person-name">‚úèÔ∏è ${p.nombre}</div>
                    <div class="person-details">
                        ${p.fechaNac ? `Nac: ${p.fechaNac}` : ''}
                        ${p.fechaDef ? ` - Def: ${p.fechaDef}` : ''}
                    </div>
                    <button class="btn-delete" onclick="event.stopPropagation(); eliminarPersona(${p.id})">üóëÔ∏è</button>
                `;
                item.onclick = () => editarPersona(p.id);
                list.appendChild(item);
            });
        }
        
        function eliminarPersona(id) {
            if (!confirm('¬øEst√°s seguro de eliminar esta persona?')) return;
            
            personas.forEach(p => {
                p.hijos = p.hijos.filter(hijoId => hijoId !== id);
                p.padres = p.padres.filter(padreId => padreId !== id);
            });
            
            personas = personas.filter(p => p.id !== id);
            
            if (editandoId === id) {
                cancelarEdicion();
            }
            
            updatePersonList();
            updateRelacionSelect();
            drawTree();
        }
        
        function editarPersona(id) {
            const persona = personas.find(p => p.id === id);
            if (!persona) return;
            
            editandoId = id;
            
            document.getElementById('nombre').value = persona.nombre;
            document.getElementById('fechaNac').value = persona.fechaNac || '';
            document.getElementById('lugarNac').value = persona.lugarNac || '';
            document.getElementById('fechaDef').value = persona.fechaDef || '';
            
            // Limpiar matrimonios
            for (let i = 1; i <= 3; i++) {
                document.getElementById(`mat${i}_fecha`).value = '';
                document.getElementById(`mat${i}_conyuge`).value = '';
            }
            
            matrimoniosCount = 1;
            document.getElementById('mat2Container').style.display = 'none';
            document.getElementById('mat3Container').style.display = 'none';
            
            persona.matrimonios.forEach((mat, index) => {
                const num = index + 1;
                if (num <= 3) {
                    document.getElementById(`mat${num}_fecha`).value = mat.fecha || '';
                    document.getElementById(`mat${num}_conyuge`).value = mat.nombreConyuge || '';
                    
                    if (num > 1) {
                        document.getElementById(`mat${num}Container`).style.display = 'flex';
                        matrimoniosCount = num;
                    }
                }
            });
            
            document.querySelector('.btn-primary').textContent = '‚úì Actualizar Persona';
            document.getElementById('btnCancelar').style.display = 'block';
            document.getElementById('relacion').parentElement.style.display = 'none';
            document.getElementById('relacionPersonaGroup').style.display = 'none';
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function cancelarEdicion() {
            editandoId = null;
            document.getElementById('personForm').reset();
            matrimoniosCount = 1;
            document.getElementById('mat2Container').style.display = 'none';
            document.getElementById('mat3Container').style.display = 'none';
            document.querySelector('.btn-primary').textContent = '+ Agregar Persona';
            document.getElementById('btnCancelar').style.display = 'none';
            document.getElementById('relacion').parentElement.style.display = 'block';
        }
        
        // ALGORITMO DE √ÅRBOL CORREGIDO
        function drawTree() {
            const canvas = document.getElementById('treeCanvas');
            const canvasInner = document.getElementById('treeCanvasInner');
            const svg = document.getElementById('linesSvg');
            
            console.log('drawTree() llamado, personas:', personas.length);
            
            // Limpiar canvas inner
            const nodesToRemove = [];
            for (let i = 0; i < canvasInner.children.length; i++) {
                const child = canvasInner.children[i];
                if (child.id !== 'linesSvg') {
                    nodesToRemove.push(child);
                }
            }
            nodesToRemove.forEach(node => node.remove());
            svg.innerHTML = '';
            
            if (personas.length === 0) {
                console.log('No hay personas para mostrar');
                return;
            }
            
            // Encontrar ra√≠z
            let raiz = personas.find(p => p.padres.length === 0);
            if (!raiz) raiz = personas[0];
            
            const layout = {};
            
            // NUEVO ALGORITMO: Calcular ancho considerando compactaci√≥n de hermanos sin hijos
            function calcularAncho(id) {
                const p = personas.find(n => n.id === id);
                if (!p) return NODE_WIDTH;
                
                // Si no tiene hijos, solo ocupa su propio ancho
                if (p.hijos.length === 0) return NODE_WIDTH;
                
                // Si tiene hijos, calcular ancho con compactaci√≥n inteligente
                let total = 0;
                for (let i = 0; i < p.hijos.length; i++) {
                    const childId = p.hijos[i];
                    const child = personas.find(n => n.id === childId);
                    const childWidth = calcularAncho(childId);
                    
                    total += childWidth;
                    
                    // Agregar espaciado antes del siguiente hermano
                    if (i < p.hijos.length - 1) {
                        const nextChildId = p.hijos[i + 1];
                        const nextChild = personas.find(n => n.id === nextChildId);
                        
                        // Si el hijo actual tiene descendientes Y el siguiente NO tiene hijos
                        // usar espacio compacto para permitir que el siguiente se "meta" en el espacio
                        if (child && child.hijos.length > 0 && nextChild && nextChild.hijos.length === 0) {
                            total += H_SPACING_COMPACT;
                        } else {
                            total += H_SPACING;
                        }
                    }
                }
                
                return Math.max(total, NODE_WIDTH);
            }
            
            // Posicionar nodos
            function posicionar(id, xStart, depth = 0) {
                const p = personas.find(n => n.id === id);
                if (!p) return;
                
                const y = depth * (NODE_HEIGHT + V_GAP) + 50;
                
                // Si es hoja (sin hijos)
                if (p.hijos.length === 0) {
                    layout[id] = { x: xStart, y: y };
                    return;
                }
                
                // Posicionar hijos uno por uno
                let currentX = xStart;
                
                for (let i = 0; i < p.hijos.length; i++) {
                    const childId = p.hijos[i];
                    const child = personas.find(n => n.id === childId);
                    
                    posicionar(childId, currentX, depth + 1);
                    
                    // Calcular posici√≥n para el siguiente hermano
                    if (i < p.hijos.length - 1) {
                        const nextChildId = p.hijos[i + 1];
                        const nextChild = personas.find(n => n.id === nextChildId);
                        
                        // ESTRATEGIA MEJORADA: Reducir gaps bas√°ndose en el √∫ltimo hijo
                        if (child && child.hijos.length > 0 && nextChild && nextChild.hijos.length > 0) {
                            // Ambos hermanos tienen hijos: posicionar basado en el √∫ltimo hijo
                            const lastChildOfCurrent = child.hijos[child.hijos.length - 1];
                            const lastChildPos = layout[lastChildOfCurrent];
                            
                            if (lastChildPos) {
                                currentX = lastChildPos.x + NODE_WIDTH + H_SPACING_SIBLINGS;
                            } else {
                                currentX = layout[childId].x + NODE_WIDTH + H_SPACING_SIBLINGS;
                            }
                        } else if (child && child.hijos.length > 0 && nextChild && nextChild.hijos.length === 0) {
                            // Hermano actual tiene hijos, siguiente no: compactar
                            currentX = layout[childId].x + NODE_WIDTH + H_SPACING_SIBLINGS;
                        } else {
                            // Caso normal: ninguno o solo el siguiente tiene hijos
                            const childWidth = calcularAncho(childId);
                            currentX += childWidth + H_SPACING;
                        }
                    }
                }
                
                // Centrar el padre sobre sus hijos
                let sumCentros = 0;
                p.hijos.forEach(childId => {
                    const childCentro = layout[childId].x + NODE_WIDTH / 2;
                    sumCentros += childCentro;
                });
                
                const centroPromedio = sumCentros / p.hijos.length;
                layout[id] = {
                    x: centroPromedio - NODE_WIDTH / 2,
                    y: y
                };
            }
            
            posicionar(raiz.id, 0, 0);
            
            // Centrar el √°rbol horizontalmente
            let minX = Infinity;
            let maxX = -Infinity;
            
            Object.values(layout).forEach(pos => {
                minX = Math.min(minX, pos.x);
                maxX = Math.max(maxX, pos.x + NODE_WIDTH);
            });
            
            // Normalizar posiciones para que empiecen en 0
            const offsetX = -minX + MARGIN;
            
            // Dibujar nodos
            const drawnNodes = {};
            
            function draw(id) {
                const p = personas.find(n => n.id === id);
                if (!p || drawnNodes[id]) return;
                
                const pos = layout[id];
                const x = pos.x + offsetX;
                const y = pos.y;
                
                // Crear nodo
                const node = document.createElement('div');
                node.className = 'tree-node';
                node.style.left = x + 'px';
                node.style.top = y + 'px';
                node.setAttribute('data-id', id);
                
                let html = `<div class="tree-node-name">${p.nombre}</div>`;
                
                if (p.fechaNac || p.lugarNac) {
                    html += `<div class="tree-node-detail">üìÖ Nac: ${p.fechaNac || ''}${p.lugarNac ? ', ' + p.lugarNac : ''}</div>`;
                }
                
                p.matrimonios.forEach(mat => {
                    if (mat.fecha || mat.nombreConyuge) {
                        html += `<div class="tree-node-detail">üíç Mat: ${mat.fecha || ''}${mat.nombreConyuge ? ' con ' + mat.nombreConyuge : ''}</div>`;
                    }
                });
                
                if (p.fechaDef) {
                    html += `<div class="tree-node-detail">‚úùÔ∏è Def: ${p.fechaDef}</div>`;
                }
                
                node.innerHTML = html;
                canvasInner.appendChild(node);
                drawnNodes[id] = node;
                
                // Dibujar hijos
                p.hijos.forEach(childId => {
                    draw(childId);
                });
            }
            
            draw(raiz.id);
            
            // Dibujar l√≠neas usando posiciones reales
            function drawLines(id) {
                const p = personas.find(n => n.id === id);
                if (!p) return;
                
                const parentNode = drawnNodes[id];
                if (!parentNode) return;
                
                const parentX = parseInt(parentNode.style.left);
                const parentY = parseInt(parentNode.style.top);
                const parentWidth = parentNode.offsetWidth;
                const parentHeight = parentNode.offsetHeight;
                
                p.hijos.forEach(childId => {
                    const childNode = drawnNodes[childId];
                    if (!childNode) return;
                    
                    const childX = parseInt(childNode.style.left);
                    const childY = parseInt(childNode.style.top);
                    const childWidth = childNode.offsetWidth;
                    
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', parentX + parentWidth / 2);
                    line.setAttribute('y1', parentY + parentHeight);
                    line.setAttribute('x2', childX + childWidth / 2);
                    line.setAttribute('y2', childY);
                    line.setAttribute('stroke', '#34495e');
                    line.setAttribute('stroke-width', '2');
                    svg.appendChild(line);
                    
                    drawLines(childId);
                });
            }
            
            drawLines(raiz.id);
            
            // Ajustar tama√±o del SVG y del contenedor interno
            let maxXCanvas = 0, maxYCanvas = 0;
            Object.values(drawnNodes).forEach(node => {
                const right = node.offsetLeft + node.offsetWidth;
                const bottom = node.offsetTop + node.offsetHeight;
                maxXCanvas = Math.max(maxXCanvas, right);
                maxYCanvas = Math.max(maxYCanvas, bottom);
            });
            
            const treeWidth = maxXCanvas + MARGIN;
            const treeHeight = maxYCanvas + 100;
            
            svg.setAttribute('width', treeWidth);
            svg.setAttribute('height', treeHeight);
            canvasInner.style.width = treeWidth + 'px';
            canvasInner.style.height = treeHeight + 'px';
            
            // ZOOM AUTOM√ÅTICO para evitar scroll horizontal
            requestAnimationFrame(() => {
                const containerWidth = canvas.clientWidth;
                const containerHeight = canvas.clientHeight;
                
                const scaleX = containerWidth / treeWidth;
                const scaleY = containerHeight / treeHeight;
                const scale = Math.min(scaleX, scaleY, 1); // Nunca agrandar
                
                canvasInner.style.transform = `scale(${scale})`;
                
                console.log(`√Årbol: ${treeWidth}x${treeHeight}px, Contenedor: ${containerWidth}x${containerHeight}px, Escala: ${(scale * 100).toFixed(0)}%`);
            });
            
            console.log('√Årbol dibujado, nodos:', Object.keys(drawnNodes).length);
        }
        
        function clearAll() {
            if (confirm('¬øEst√°s seguro de limpiar todo?')) {
                personas = [];
                nextId = 1;
                matrimoniosCount = 1;
                document.getElementById('mat2Container').style.display = 'none';
                document.getElementById('mat3Container').style.display = 'none';
                updatePersonList();
                updateRelacionSelect();
                drawTree();
            }
        }
        
        function exportToPDF() {
            const canvasInner = document.getElementById('treeCanvasInner');
            
            if (personas.length === 0) {
                alert('No hay personas en el √°rbol para exportar');
                return;
            }
            
            // Guardar estado original
            const originalTransform = canvasInner.style.transform;
            
            // Quitar zoom de pantalla temporalmente
            canvasInner.style.transform = 'scale(1)';
            
            setTimeout(() => {
                // Obtener dimensiones reales del √°rbol
                const treeWidth = parseInt(canvasInner.style.width) || 0;
                const treeHeight = parseInt(canvasInner.style.height) || 0;
                
                // Escalar a tama√±o razonable SIN asumir tama√±o de p√°gina espec√≠fico
                // L√≠mite razonable: max 1200px en cualquier dimensi√≥n
                const maxDimension = 1200;
                const scaleX = treeWidth > maxDimension ? maxDimension / treeWidth : 1;
                const scaleY = treeHeight > maxDimension ? maxDimension / treeHeight : 1;
                const scale = Math.min(scaleX, scaleY, 1);
                
                // Aplicar escala - flexbox en @media print centra autom√°ticamente
                canvasInner.style.transform = `scale(${scale})`;
                
                console.log('Exportando PDF:');
                console.log(`  √Årbol: ${treeWidth}x${treeHeight}px`);
                console.log(`  Escala: ${(scale * 100).toFixed(0)}%`);
                console.log(`  Tama√±o max: ${maxDimension}px`);
                console.log(`  ‚úì Centrado autom√°tico con flexbox`);
                console.log(`  ‚úì Usuario configura tama√±o y orientaci√≥n`);
                
                // Imprimir
                setTimeout(() => {
                    window.print();
                    
                    // Restaurar estado original
                    setTimeout(() => {
                        canvasInner.style.transform = originalTransform;
                    }, 100);
                }, 100);
            }, 50);
        }
    </script>
</body>
</html>
